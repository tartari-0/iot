<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard IIoT Industrial</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 font-sans p-6">
  <h1 class="text-3xl font-bold mb-6">Monitoramento Industrial IIoT</h1>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl">
    <div class="bg-white rounded shadow p-6 text-center">
      <h2 class="text-xl font-semibold text-red-600 mb-2">Temperatura Atual</h2>
      <p id="tempAtual" class="text-4xl font-bold text-red-600">-- °C</p>
    </div>
    <div class="bg-white rounded shadow p-6 text-center">
      <h2 class="text-xl font-semibold text-blue-600 mb-2">Pressão Atual</h2>
      <p id="pressaoAtual" class="text-4xl font-bold text-blue-600">-- bar</p>
    </div>
    <div class="bg-white rounded shadow p-6 text-center">
      <h2 class="text-xl font-semibold text-green-600 mb-2">Volume Total Corrigido</h2>
      <p id="volumeTotal" class="text-4xl font-bold text-green-600">-- nm³</p>
    </div>
  </div>

  <div class="max-w-4xl mx-auto mt-10">
    <h2 class="text-2xl font-bold mb-4">Análise Temporal</h2>
    <canvas id="tempChart" class="mb-10" height="150"></canvas>
    <canvas id="pressChart" class="mb-10" height="150"></canvas>
    <canvas id="volChart" height="150"></canvas>
  </div>

  <script>
    let tempChart, pressChart, volChart;

    function criarGrafico(id, label, cor, unidade) {
        const ctx = document.getElementById(id).getContext('2d');
        return new Chart(ctx, {
        type: 'line',
        data: {
        labels: [],
        datasets: [{
            label: `${label} (${unidade})`,
            data: [],
            borderColor: cor,
            backgroundColor: cor.replace('1)', '0.1)'),
            fill: true,
            tension: 0.3,
            pointRadius: 3,
            pointHoverRadius: 6
        }]
        },
        options: {
        responsive: true,
        interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
        },
        plugins: {
            legend: { display: true },
            tooltip: { enabled: true }
        },
        scales: {
            x: { 
            title: { display: true, text: 'Timestamp' },
            ticks: { maxRotation: 45, minRotation: 45 }
            },
            y: {
            title: { display: true, text: `${label} (${unidade})` },
            beginAtZero: false
            }
        }
        }
    });
    }

    // Converte Pa para bar
    function paParaBar(pa) {
      return pa / 100000;
    }

    async function atualizarGraficos() {
      try {
        const res = await fetch('/api/dados');
        const data = await res.json();

        const dados = data.dados;
        const volumeTotal = data.volume_total_corrigido;

        if (dados.length === 0) return;

        const timestamps = dados.map(d => d.timestamp);
        const temperaturas = dados.map(d => d.temperatura);
        const pressaoBar = dados.map(d => paParaBar(d.pressao));
        const volumes = [];

        const VOLUME = 1;
        const PATM = 1;
        const STD_PATM = 1;
        const STD_TEMP = 20;

        for (let i = 0; i < dados.length; i++) {
          const vol = (VOLUME * (pressaoBar[i] + PATM * 1.01325) * (STD_TEMP + 273.15)) / 
                      ((temperaturas[i] + 273.15) * (STD_PATM * 1.01325));
          volumes.push(vol);
        }

        // Atualiza valores atuais
        document.getElementById('tempAtual').textContent = temperaturas.at(-1).toFixed(2) + ' °C';
        document.getElementById('pressaoAtual').textContent = pressaoBar.at(-1).toFixed(3) + ' PSI';
        document.getElementById('volumeTotal').textContent = volumeTotal.toFixed(2) + ' nm³';

        // Inicializa gráficos se necessário
        if (!tempChart) tempChart = criarGrafico('tempChart', 'Temperatura', 'rgb(239,68,68)', '°C');
        if (!pressChart) pressChart = criarGrafico('pressChart', 'Pressão', 'rgb(59,130,246)', 'PSI');
        if (!volChart) volChart = criarGrafico('volChart', 'Volume Corrigido', 'rgb(34,197,94)', 'nm³/h');

        // Atualiza dados dos gráficos
        tempChart.data.labels = timestamps;
        tempChart.data.datasets[0].data = temperaturas;
        tempChart.update();

        pressChart.data.labels = timestamps;
        pressChart.data.datasets[0].data = pressaoBar;
        pressChart.update();

        volChart.data.labels = timestamps;
        volChart.data.datasets[0].data = volumes;
        volChart.update();

      } catch (err) {
        console.error('Erro ao atualizar gráficos:', err);
      }
    }

    atualizarGraficos();
    setInterval(atualizarGraficos, 2000);
  </script>
</body>
</html>