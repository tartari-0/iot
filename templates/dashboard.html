<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>Dashboard IoT - Temperatura & Pressão</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: #f7f9fc;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            padding: 25px;
        }
        h1 {
            text-align: center;
            font-weight: 700;
            color: #222;
            margin-bottom: 35px;
        }
        .card {
            box-shadow: 0 4px 10px rgb(0 0 0 / 0.1);
            border-radius: 12px;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
        }
        .stat-label {
            font-size: 1.1rem;
            color: #555;
            font-weight: 600;
        }
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #111;
        }
    </style>
</head>
<body>
    <h1>Dashboard IoT - Temperatura & Pressão</h1>
    <div class="container">

        <div class="row g-4">
            <div class="col-md-6">
                <div class="card">
                    <div>
                        <p class="stat-label">Temperatura Atual</p>
                        <p id="temp-ultima" class="stat-value">-- °C</p>
                    </div>
                    <canvas id="tempChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div>
                        <p class="stat-label">Pressão Atual</p>
                        <p id="pressao-ultima" class="stat-value">-- hPa</p>
                    </div>
                    <canvas id="pressaoChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card">
            <h4>Resumo Estatístico (Últimos dados)</h4>
            <div class="row text-center mt-3">
                <div class="col-md-4">
                    <p class="stat-label">Temperatura Média</p>
                    <p id="temp-media" class="stat-value">-- °C</p>
                </div>
                <div class="col-md-4">
                    <p class="stat-label">Pressão Média</p>
                    <p id="pressao-media" class="stat-value">-- hPa</p>
                </div>
                <div class="col-md-4">
                    <p class="stat-label">Total de Leituras</p>
                    <p id="total-leituras" class="stat-value">0</p>
                </div>
            </div>
        </div>

    </div>

<script>
    const tempCtx = document.getElementById('tempChart').getContext('2d');
    const pressaoCtx = document.getElementById('pressaoChart').getContext('2d');

    const tempChart = new Chart(tempCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Temperatura (°C)',
                data: [],
                borderColor: '#e74c3c',
                backgroundColor: 'rgba(231, 76, 60, 0.2)',
                fill: true,
                tension: 0.3,
                pointRadius: 0,
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    title: { display: true, text: 'Horário' },
                    ticks: { maxTicksLimit: 10 },
                    type: 'time',
                    time: {
                        tooltipFormat: 'HH:mm:ss',
                        unit: 'minute',
                        displayFormats: { minute: 'HH:mm' }
                    }
                },
                y: {
                    title: { display: true, text: '°C' },
                    suggestedMin: 0,
                    suggestedMax: 50
                }
            },
            plugins: { legend: { display: true } }
        }
    });

    const pressaoChart = new Chart(pressaoCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Pressão (hPa)',
                data: [],
                borderColor: '#2980b9',
                backgroundColor: 'rgba(41, 128, 185, 0.2)',
                fill: true,
                tension: 0.3,
                pointRadius: 0,
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    title: { display: true, text: 'Horário' },
                    ticks: { maxTicksLimit: 10 },
                    type: 'time',
                    time: {
                        tooltipFormat: 'HH:mm:ss',
                        unit: 'minute',
                        displayFormats: { minute: 'HH:mm' }
                    }
                },
                y: {
                    title: { display: true, text: 'hPa' },
                    suggestedMin: 900,
                    suggestedMax: 1100
                }
            },
            plugins: { legend: { display: true } }
        }
    });

    function calcMedia(arr) {
        if (!arr.length) return 0;
        const sum = arr.reduce((acc, val) => acc + val, 0);
        return (sum / arr.length).toFixed(2);
    }

    async function atualizarDashboard() {
        try {
            const res = await fetch('/dados');
            const dados = await res.json();

            if (!dados.length) {
                return;
            }

            // converter timestamps em objetos Date
            const labels = dados.map(d => new Date(d.timestamp));
            const temperaturas = dados.map(d => d.temperatura);
            const pressao = dados.map(d => d.pressao);

            // Atualiza gráficos
            tempChart.data.labels = labels;
            tempChart.data.datasets[0].data = temperaturas;
            tempChart.update();

            pressaoChart.data.labels = labels;
            pressaoChart.data.datasets[0].data = pressao;
            pressaoChart.update();

            // Atualiza estatísticas e valores atuais
            document.getElementById('temp-ultima').textContent = temperaturas[temperaturas.length - 1] + " °C";
            document.getElementById('pressao-ultima').textContent = pressao[pressao.length - 1] + " hPa";

            document.getElementById('temp-media').textContent = calcMedia(temperaturas) + " °C";
            document.getElementById('pressao-media').textContent = calcMedia(pressao) + " hPa";

            document.getElementById('total-leituras').textContent = dados.length;

        } catch (error) {
            console.error("Erro ao atualizar dashboard:", error);
        }
    }

    // Atualiza a cada 3 segundos para dashboard fluido
    setInterval(atualizarDashboard, 3000);
    atualizarDashboard();

</script>

</body>
</html>